<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('./includes/head') %>
    <title>Doctor Dashboard - MedLink</title>
    <link rel="stylesheet" href="/styles/reset.css" />
    <link rel="stylesheet" href="/styles/navbar.css" />
    <link rel="stylesheet" href="/styles/doctorDashboard.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>
  <body>
    <%- include('./includes/header') %>

    <main class="dashboard-container">
      <div class="profile-header">
        <img src="<%= doctor.image %>" alt="Doctor Image" class="profile-img" />
        <div class="profile-info">
          <h2>Dr. <%= doctor.name %></h2>
          <p><i class="fas fa-stethoscope"></i> <%= doctor.field %></p>
          <p><i class="fas fa-envelope"></i> <%= doctor.email %></p>
        </div>
      </div>

      <div class="dashboard-main">
        <div class="dashboard-nav">
          <a
            href="#"
            class="nav-item active"
            onclick="showSection('appointments')"
            ><i class="fas fa-calendar-check"></i> Appointments</a
          >
          <a href="#" class="nav-item" onclick="showSection('slots')"
            ><i class="fas fa-clock"></i> Manage Slots</a
          >
          <a href="/doctorProfile" class="nav-item"
            ><i class="fas fa-user-edit"></i> Profile</a
          >
          <a href="/api/doctors/logout" class="nav-item"
            ><i class="fas fa-sign-out-alt"></i> Logout</a
          >
        </div>

        <div class="dashboard-content">
          <div id="appointments-section" class="content-section active">
            <h2>Your Appointments</h2>
            <div id="appointments-list" class="appointments-container"></div>
          </div>

          <div id="slots-section" class="content-section" style="display: none">
            <h2>Manage Slots</h2>
            <div class="slot-controls">
              <label for="slot-date">Select Date:</label>
              <input type="date" id="slot-date" />
              <button onclick="loadSlots()" class="btn">Load Slots</button>
            </div>
            <div id="slots-list" class="slots-container"></div>
          </div>
        </div>
      </div>
    </main>

    <%- include('./includes/footer') %>

    <script>
      function showSection(section) {
        document
          .querySelectorAll(".content-section")
          .forEach((s) => (s.style.display = "none"));
        document.getElementById(section + "-section").style.display = "block";
        document
          .querySelectorAll(".nav-item")
          .forEach((n) => n.classList.remove("active"));
        document
          .querySelector(`.nav-item[onclick="showSection('${section}')"]`)
          ?.classList.add("active");

        if (section === "appointments") {
          loadAppointments();
        } else if (section === "slots") {
          // Pre-set date and load slots immediately
          const today = new Date().toISOString().split("T")[0];
          document.getElementById("slot-date").value = today;
          loadSlots();
        }
      }

      async function loadAppointments() {
        try {
          // FIX: Corrected API endpoint
          const response = await fetch("/api/doctors/appointments");
          const appointments = await response.json();
          const list = document.getElementById("appointments-list");
          list.innerHTML = "";

          if (appointments.length === 0) {
            list.innerHTML =
              "<p class='no-appointments'>No upcoming appointments found.</p>";
          } else {
            appointments.forEach((apt) => {
              const div = document.createElement("div");
              div.className = "appointment-item"; // Using existing CSS class
              div.innerHTML = `
                            <div class="appointment-header">
                              <h3>Appointment with ${apt.user.name}</h3>
                              <span class="status status-${apt.status.toLowerCase()}">${
                apt.status
              }</span>
                            </div>
                            <div class="appointment-details">
                                <p><i class="fas fa-user"></i> <strong>Patient:</strong> ${
                                  apt.user.name
                                } (${apt.user.email})</p>
                                <p><i class="fas fa-calendar"></i> <strong>Date:</strong> ${new Date(
                                  apt.date
                                ).toLocaleDateString()}</p>
                                <p><i class="fas fa-clock"></i> <strong>Time:</strong> ${
                                  apt.time
                                }</p>
                            </div>
                        `;
              list.appendChild(div);
            });
          }
        } catch (error) {
          console.error("Error loading appointments:", error);
          document.getElementById("appointments-list").innerHTML =
            "<p class='error-message'>Failed to load appointments.</p>";
        }
      }

      async function loadSlots() {
        const date = document.getElementById("slot-date").value;
        if (!date) {
          alert("Please select a date");
          return;
        }

        try {
          // FIX: Corrected API endpoint - Doctor ID is inferred from session on the backend
          const slotsResponse = await fetch(`/api/doctors/slots?date=${date}`);
          if (!slotsResponse.ok) {
            throw new Error(
              "Failed to fetch slots. You might need to be logged in."
            );
          }

          const slots = await slotsResponse.json();
          const list = document.getElementById("slots-list");
          list.innerHTML = "";

          if (slots.length === 0) {
            list.innerHTML =
              "<p class='no-slots'>No slots generated for this date. They will be created upon user booking attempt.</p>";
            return;
          }

          slots.forEach((slot) => {
            const div = document.createElement("div");
            let slotClass = "slot";
            let buttonHtml = "";

            if (slot.available === false) {
              slotClass += " unavailable";
            }
            // Note: `isBooked` property is not in `doctorSlot.js` model. We assume `available: false` means booked/unavailable.

            if (slot.available === false) {
              // This slot is either booked or manually made unavailable
              slotClass += " unavailable";
              buttonHtml = `
                <button onclick="toggleAvailability('${slot._id}', true)" class="btn-availability">
                    Make Available
                </button>
              `;
            } else {
              slotClass += " available";
              buttonHtml = `
                <button onclick="toggleAvailability('${slot._id}', false)" class="btn-availability">
                    Make Unavailable
                </button>
              `;
            }

            div.className = slotClass;
            div.innerHTML = `
                        <div class="slot-time">
                            <i class="fas fa-clock"></i> ${slot.time}
                        </div>
                        <div class="slot-actions">
                            ${buttonHtml}
                            <button onclick="editTime('${slot._id}', '${slot.time}')" class="btn-edit btn-secondary">
                                <i class="fas fa-edit"></i> Edit Time
                            </button>
                        </div>
                    `;
            list.appendChild(div);
          });
        } catch (error) {
          console.error("Error loading slots:", error);
          document.getElementById(
            "slots-list"
          ).innerHTML = `<p class='error-message'>${error.message}</p>`;
        }
      }

      async function toggleAvailability(slotId, available) {
        try {
          // FIX: Corrected API endpoint
          const response = await fetch(
            `/api/doctors/slots/${slotId}/availability`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ available }),
            }
          );
          const result = await response.json();
          if (response.ok) {
            loadSlots();
          } else {
            alert("Error updating slot: " + result.message);
          }
        } catch (error) {
          console.error("Error toggling availability:", error);
        }
      }

      async function editTime(slotId, currentTime) {
        const newTime = prompt(
          "Enter new time (HH:MM format, e.g., 14:30):",
          currentTime
        );
        if (!newTime || newTime === currentTime) return;

        const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
        if (!timeRegex.test(newTime)) {
          alert("Please enter a valid time in HH:MM format.");
          return;
        }

        try {
          // FIX: Corrected API endpoint
          const response = await fetch(`/api/doctors/slots/${slotId}/time`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ time: newTime }),
          });
          const result = await response.json();
          if (response.ok) {
            loadSlots();
          } else {
            alert("Error updating slot time: " + result.message);
          }
        } catch (error) {
          console.error("Error editing time:", error);
        }
      }

      // Load appointments by default
      document.addEventListener("DOMContentLoaded", () => {
        showSection("appointments");
      });
    </script>
  </body>
</html>
