<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('includes/head') %>
    <link href="styles/profile.css" rel="stylesheet" />
  </head>
  <body>
    <%- include('includes/header') %>
    <div class="profile-container">
      <div class="profile-header">
        <div class="avatar">
          <i class="fas fa-user"></i>
        </div>
        <h2 id="user-name">Loading...</h2>
      </div>
      <div class="profile-content">
        <div class="card">
          <h3>My Appointments</h3>
          <ul id="appointments-list">
            <li>No appointments to show.</li>
          </ul>
        </div>
        <div class="card">
          <h3>General Info</h3>
          <p><strong>Name:</strong> <span id="info-name">Loading...</span></p>
          <p>
            <strong>Username:</strong>
            <span id="info-username">Loading...</span>
          </p>
          <p><strong>Email:</strong> <span id="info-email">Loading...</span></p>
        </div>
      </div>
      <div class="medicines-section">
        <h3>Purchased Medicines</h3>
        <button id="clear-medicines-btn" class="clear-btn">Clear All Medicines</button>
        <div id="medicines-list">
          <div class="no-medicines">No medicines purchased yet.</div>
        </div>
      </div>
    </div>

    <script>
      async function fetchUserInfo() {
        try {
          const response = await fetch("/api/users/profile");
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          if (data.user) {
            document.getElementById("user-name").textContent =
              data.user.name || "N/A";

            document.getElementById("info-name").textContent =
              data.user.name || "N/A";
            document.getElementById("info-username").textContent =
              data.user.username || "N/A";
            document.getElementById("info-email").textContent =
              data.user.email || "N/A";

            // Display purchased medicines
            const medicinesList = document.getElementById("medicines-list");
            if (data.user.purchasedMedicines && data.user.purchasedMedicines.length > 0) {
              medicinesList.innerHTML = '';
              data.user.purchasedMedicines.forEach(medicine => {
                const medicineCard = document.createElement('div');
                medicineCard.className = 'medicine-card';
                medicineCard.innerHTML = `
                  <img src="${medicine.image}" alt="${medicine.name}" class="medicine-image">
                  <div class="medicine-details">
                    <h4>${medicine.name}</h4>
                    <p>Quantity: ${medicine.quantity}</p>
                    <p>Price: â‚¹${medicine.price}</p>
                    <p>Date: ${new Date(medicine.date).toLocaleDateString()}</p>
                  </div>
                `;
                medicinesList.appendChild(medicineCard);
              });
            } else {
              medicinesList.innerHTML = '<div class="no-medicines">No medicines purchased yet.</div>';
            }
          } else {
            document.getElementById("user-name").textContent = "Guest";
            document.getElementById("info-name").textContent = "N/A";
            document.getElementById("info-username").textContent = "N/A";
            document.getElementById("info-email").textContent = "N/A";
            document.getElementById("medicines-list").innerHTML = '<div class="no-medicines">No medicines purchased yet.</div>';
          }
        } catch (error) {
          console.error("Failed to fetch user info:", error);
          document.getElementById("user-name").textContent =
            "Error loading user info";
          document.getElementById("info-name").textContent = "Error";
          document.getElementById("info-username").textContent = "Error";
          document.getElementById("info-email").textContent = "Error";
          document.getElementById("medicines-list").innerHTML = '<div class="no-medicines">Error loading medicines.</div>';
        }
      }

      // Clear all medicines button
      document.getElementById('clear-medicines-btn').addEventListener('click', async () => {
        if (confirm('Are you sure you want to clear all purchased medicines?')) {
          try {
            const response = await fetch('/api/users/clear-medicines', {
              method: 'DELETE'
            });
            if (response.ok) {
              alert('All medicines cleared successfully!');
              fetchUserInfo(); // Refresh the profile
            } else {
              alert('Failed to clear medicines.');
            }
          } catch (error) {
            console.error('Error clearing medicines:', error);
            alert('Error clearing medicines.');
          }
        }
      });

      fetchUserInfo();
    </script>
    <%- include('includes/footer') %>
  </body>
</html>
